<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liuxingjun.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="最近看的阻塞和异步的资料看的比较多，对基础的概念也理解的深了一点点 因为上次项目中一个接口耗时比较长，所以来优化下 项目本身的逻辑上，填写手机号-&gt;生成小程序二维码-&gt;上传二维码到七牛-&gt;更改数据库邀请码图片-&gt;返回API响应 其中 生成二维码和上传二维码到七牛均是一个阻塞网络IO 改进的基本想法是：在还没有创建子进程时生成小程序二维码，得到url，然后创建进程，在主进程">
<meta property="og:type" content="article">
<meta property="og:title" content="子进程上传文件">
<meta property="og:url" content="https://liuxingjun.github.io/2018/04/23/%E5%AD%90%E8%BF%9B%E7%A8%8B%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6/index.html">
<meta property="og:site_name" content="刘星军的博客">
<meta property="og:description" content="最近看的阻塞和异步的资料看的比较多，对基础的概念也理解的深了一点点 因为上次项目中一个接口耗时比较长，所以来优化下 项目本身的逻辑上，填写手机号-&gt;生成小程序二维码-&gt;上传二维码到七牛-&gt;更改数据库邀请码图片-&gt;返回API响应 其中 生成二维码和上传二维码到七牛均是一个阻塞网络IO 改进的基本想法是：在还没有创建子进程时生成小程序二维码，得到url，然后创建进程，在主进程">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2018-04-23T10:57:32.000Z">
<meta property="article:modified_time" content="2022-03-25T08:49:30.817Z">
<meta property="article:author" content="刘星军">
<meta property="article:tag" content="pcntl_fork">
<meta property="article:tag" content="七牛">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://liuxingjun.github.io/2018/04/23/%E5%AD%90%E8%BF%9B%E7%A8%8B%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>子进程上传文件 | 刘星军的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">刘星军的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">10</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">14</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">4</span></a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liuxingjun.github.io/2018/04/23/%E5%AD%90%E8%BF%9B%E7%A8%8B%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="刘星军">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="刘星军的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          子进程上传文件
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-04-23 10:57:32" itemprop="dateCreated datePublished" datetime="2018-04-23T10:57:32+00:00">2018-04-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-25 08:49:30" itemprop="dateModified" datetime="2022-03-25T08:49:30+00:00">2022-03-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php/" itemprop="url" rel="index"><span itemprop="name">php</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>最近看的阻塞和异步的资料看的比较多，对基础的概念也理解的深了一点点</p>
<p>因为上次项目中一个接口耗时比较长，所以来优化下</p>
<p>项目本身的逻辑上，填写手机号-&gt;生成小程序二维码-&gt;上传二维码到七牛-&gt;更改数据库邀请码图片-&gt;返回API响应</p>
<p>其中 生成二维码和上传二维码到七牛均是一个阻塞网络IO</p>
<p>改进的基本想法是：在还没有创建子进程时生成小程序二维码，得到url，然后创建进程，在主进程 响应API接口信息，子进程继续上传图片到七牛，上传成功修改数据库信息</p>
<p>废话不多说，直接上代码</p>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><span id="more"></span>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//getRandChar方法是自己编写的随机字符串方法</span></span><br><span class="line"><span class="variable">$file_name</span>=<span class="title function_ invoke__">uniqid</span>(<span class="title function_ invoke__">time</span>().<span class="title function_ invoke__">getRandChar</span>(<span class="number">8</span>)).<span class="string">&#x27;.jpg&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 必须加载扩展</span></span><br><span class="line"><span class="comment">//pcntl_fork只有Linux才可以使用，因为本地调试，我写了一个不用子进程的方式兼容本地</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">function_exists</span> ( <span class="string">&quot;pcntl_fork&quot;</span> )) &#123;</span><br><span class="line">    <span class="variable">$pid</span> = <span class="title function_ invoke__">pcntl_fork</span> (); <span class="comment">// 创建子进程</span></span><br><span class="line">    <span class="title class_">Log</span>::<span class="title function_ invoke__">info</span>(<span class="string">&#x27;创建进程&#x27;</span>);</span><br><span class="line">    <span class="comment">// 父进程和子进程都会执行下面代码</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$pid</span> == - <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 错误处理：创建子进程失败时返回-1.</span></span><br><span class="line">        <span class="title class_">Log</span>::<span class="title function_ invoke__">info</span>(<span class="string">&#x27;进程创建失败&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$pid</span>) &#123;</span><br><span class="line">        <span class="comment">// 父进程会得到子进程号，所以这里是父进程执行的逻辑</span></span><br><span class="line">        <span class="comment">// 如果不需要阻塞进程，而又想得到子进程的退出状态，则可以注释掉pcntl_wait($status)语句，或写成：</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等待子进程中断，防止子进程成为僵尸进程。</span></span><br><span class="line">        <span class="title function_ invoke__">pcntl_wait</span> ( <span class="variable">$status</span>, WNOHANG ); </span><br><span class="line"></span><br><span class="line">        <span class="comment">//响应API信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">show</span>([<span class="string">&#x27;status&#x27;</span>=&gt;<span class="string">&#x27;10000&#x27;</span>,<span class="string">&#x27;data&#x27;</span>=&gt; <span class="title function_ invoke__">config</span>(<span class="string">&#x27;qiniu.domain&#x27;</span>).<span class="variable">$file_name</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//子进程得到的$pid为0, 所以这里是子进程执行的逻辑。</span></span><br><span class="line">        <span class="comment">//上传文件到七牛</span></span><br><span class="line">        <span class="variable">$QrCodeUrl</span>= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">uploadQrCode</span>(<span class="variable">$file_name</span>,<span class="variable">$image</span>);</span><br><span class="line">        <span class="comment">//原生mysql连接修改数据库</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">updateQrCode</span>(<span class="variable">$agent</span>-&gt;agent_id,<span class="variable">$QrCodeUrl</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">exit</span> ( <span class="number">0</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$QrCodeUrl</span>= <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">uploadQrCode</span>(<span class="variable">$file_name</span>,<span class="variable">$image</span>);</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">updateQrCode</span>(<span class="variable">$agent</span>-&gt;agent_id,<span class="variable">$QrCodeUrl</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">show</span>([<span class="string">&#x27;status&#x27;</span>=&gt;<span class="string">&#x27;10000&#x27;</span>,<span class="string">&#x27;data&#x27;</span>=&gt; <span class="title function_ invoke__">config</span>(<span class="string">&#x27;qiniu.domain&#x27;</span>).<span class="variable">$file_name</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>show</code>方法为自己封装的响应方法</p>
</blockquote>
<p>uploadQrCode 方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$qiniuAuth</span> = <span class="keyword">new</span> <span class="title class_">QiniuAuth</span>(<span class="title function_ invoke__">config</span>(<span class="string">&#x27;qiniu.accessKey&#x27;</span>), <span class="title function_ invoke__">config</span>(<span class="string">&#x27;qiniu.secretKey&#x27;</span>));</span><br><span class="line"><span class="title class_">Log</span>::<span class="title function_ invoke__">info</span>(<span class="string">&#x27;文件上传配置accessKey:&#x27;</span>.<span class="title function_ invoke__">config</span>(<span class="string">&#x27;qiniu.accessKey&#x27;</span>).<span class="string">&#x27;-secretKey:&#x27;</span>. <span class="title function_ invoke__">config</span>(<span class="string">&#x27;qiniu.secretKey&#x27;</span>));</span><br><span class="line"><span class="variable">$token</span> = <span class="variable">$qiniuAuth</span>-&gt;<span class="title function_ invoke__">uploadToken</span>(<span class="string">&#x27;aybc&#x27;</span>);</span><br><span class="line"><span class="title class_">Log</span>::<span class="title function_ invoke__">info</span>(<span class="string">&#x27;文件上传token:&#x27;</span>.<span class="variable">$token</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$Upload</span> = <span class="keyword">new</span> <span class="title class_">qiniuUpload</span>();</span><br><span class="line"><span class="title class_">Log</span>::<span class="title function_ invoke__">info</span>(<span class="string">&#x27;子进程上传图片参数：&#x27;</span>.<span class="variable">$file_name</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">list</span>(<span class="variable">$ret</span>, <span class="variable">$error</span>) = <span class="variable">$Upload</span>-&gt;<span class="title function_ invoke__">put</span>(<span class="variable">$token</span>, <span class="variable">$file_name</span>, <span class="variable">$image</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$error</span> != <span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="title class_">Log</span>::<span class="title function_ invoke__">info</span>(<span class="string">&#x27;文件上传出错&#x27;</span>.<span class="title function_ invoke__">json_encode</span>(<span class="variable">$error</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$ret</span>[<span class="string">&#x27;key&#x27;</span>];</span><br></pre></td></tr></table></figure>



<h2 id="R-DEVICE-ERROR错误"><a href="#R-DEVICE-ERROR错误" class="headerlink" title="R_DEVICE_ERROR错误"></a>R_DEVICE_ERROR错误</h2><p>A PKCS #11 module returned CK R_DEVICE_ERROR, indicating that a problem has</p>
<p>原因大致是在进程中使用了外部的ssl秘钥的原因</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/15466809/libcurl-ssl-error-after-fork">https://stackoverflow.com/questions/15466809/libcurl-ssl-error-after-fork</a></p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/26285311/ssl-requests-made-with-curl-fail-after-process-fork">https://stackoverflow.com/questions/26285311/ssl-requests-made-with-curl-fail-after-process-fork</a></p>
</blockquote>
<p>以上是一些参考资料<br>解决方案我列举几个</p>
<ol>
<li><p>pcntl_exec<br>  讲子进程的请求外部资源的代码写到一个php文件，使用pcntl_exec 执行这个 PHP<br>  传参方式可以参考PHP官方文档<a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.pcntl-exec.php" title="pcntl-exec">pcntl-exec</a></p>
</li>
<li><p>子进程不使用curl方式<br>  使用fsockopen，file_get_content</p>
</li>
<li><p>使用 socket_create_pair</p>
</li>
</ol>
<p>  参考PHP文档<a target="_blank" rel="noopener" href="http://php.net/manual/zh/function.socket-create-pair.php" title="socket_create_pair">socket_create_pair</a><br>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ary</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="variable">$strone</span> = <span class="string">&#x27;Message From Parent.&#x27;</span>;</span><br><span class="line"><span class="variable">$strtwo</span> = <span class="string">&#x27;Message From Child.&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">socket_create_pair</span>(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, <span class="variable">$ary</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;socket_create_pair() failed. Reason: &quot;</span>.<span class="title function_ invoke__">socket_strerror</span>(<span class="title function_ invoke__">socket_last_error</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$pid</span> = <span class="title function_ invoke__">pcntl_fork</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$pid</span> == -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Could not fork Process.&#x27;</span>;</span><br><span class="line">&#125; <span class="keyword">elseif</span> (<span class="variable">$pid</span>) &#123;</span><br><span class="line">    <span class="comment">/*parent*/</span></span><br><span class="line">    <span class="title function_ invoke__">socket_close</span>(<span class="variable">$ary</span>[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">socket_write</span>(<span class="variable">$ary</span>[<span class="number">1</span>], <span class="variable">$strone</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$strone</span>)) === <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;socket_write() failed. Reason: &quot;</span>.<span class="title function_ invoke__">socket_strerror</span>(<span class="title function_ invoke__">socket_last_error</span>(<span class="variable">$ary</span>[<span class="number">1</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">socket_read</span>(<span class="variable">$ary</span>[<span class="number">1</span>], <span class="title function_ invoke__">strlen</span>(<span class="variable">$strtwo</span>), PHP_BINARY_READ) == <span class="variable">$strtwo</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Recieved <span class="subst">$strtwo</span>\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">socket_close</span>(<span class="variable">$ary</span>[<span class="number">1</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">/*child*/</span></span><br><span class="line">    <span class="title function_ invoke__">socket_close</span>(<span class="variable">$ary</span>[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">socket_write</span>(<span class="variable">$ary</span>[<span class="number">0</span>], <span class="variable">$strtwo</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$strtwo</span>)) === <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;socket_write() failed. Reason: &quot;</span>.<span class="title function_ invoke__">socket_strerror</span>(<span class="title function_ invoke__">socket_last_error</span>(<span class="variable">$ary</span>[<span class="number">0</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">socket_read</span>(<span class="variable">$ary</span>[<span class="number">0</span>], <span class="title function_ invoke__">strlen</span>(<span class="variable">$strone</span>), PHP_BINARY_READ) == <span class="variable">$strone</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Recieved <span class="subst">$strone</span>\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">socket_close</span>(<span class="variable">$ary</span>[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol start="4">
<li>不使用https<br>  父进程中采用http访问,或者所有子进程中都都采用http访问</li>
</ol>
<h2 id="PDO错误"><a href="#PDO错误" class="headerlink" title="PDO错误"></a>PDO错误</h2><p>PDO::prepare(): send of 66 bytes failed with errno&#x3D;32 Broken pipe<br> 如果你在子进程使用框架的Model修改数据库，可能会有这个保存<br> 错误原因是框架里的数据库连接是使用的同一个连接<br> 解决方案是在子进程使用原生方式创建一个数据库连接<br> updateQrCode 方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$dbConfig</span> = <span class="title class_">Config</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;database&#x27;</span>);</span><br><span class="line"></span><br><span class="line"> <span class="variable">$mysqli</span> = @<span class="keyword">new</span> <span class="title class_">\mysqli</span>(<span class="variable">$dbConfig</span>[<span class="string">&#x27;hostname&#x27;</span>].<span class="string">&#x27;:&#x27;</span>.<span class="variable">$dbConfig</span>[<span class="string">&#x27;hostport&#x27;</span>], <span class="variable">$dbConfig</span>[<span class="string">&#x27;username&#x27;</span>], <span class="variable">$dbConfig</span>[<span class="string">&#x27;password&#x27;</span>]);</span><br><span class="line"> <span class="keyword">if</span> (<span class="variable">$mysqli</span>-&gt;connect_errno) &#123;</span><br><span class="line">     <span class="title class_">Log</span>::<span class="title function_ invoke__">info</span>(<span class="string">&quot;could not connect to the database:\n&quot;</span> . <span class="variable">$mysqli</span>-&gt;connect_error);<span class="comment">//诊断连接错误</span></span><br><span class="line"> &#125;</span><br><span class="line"> <span class="variable">$mysqli</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&quot;set names &#x27;utf8&#x27;;&quot;</span>);<span class="comment">//编码转化</span></span><br><span class="line"> <span class="variable">$select_db</span> = <span class="variable">$mysqli</span>-&gt;<span class="title function_ invoke__">select_db</span>(<span class="variable">$dbConfig</span>[<span class="string">&#x27;database&#x27;</span>]);</span><br><span class="line"> <span class="keyword">if</span> (!<span class="variable">$select_db</span>) &#123;</span><br><span class="line">     <span class="title class_">Log</span>::<span class="title function_ invoke__">info</span>(<span class="string">&quot;could not connect to the db:\n&quot;</span> .  <span class="variable">$mysqli</span>-&gt;error);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="variable">$sql</span> = <span class="string">&quot;UPDATE we_chat_agents SET qr_code = ? WHERE agent_id = ? ;&quot;</span>;</span><br><span class="line"> <span class="variable">$stmt</span> = <span class="variable">$mysqli</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="variable">$sql</span>);</span><br><span class="line"></span><br><span class="line"> <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;si&quot;</span>,<span class="variable">$qr_code</span>,<span class="variable">$agent_id</span> );</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* Execute the statement */</span></span><br><span class="line"> <span class="keyword">if</span> (!<span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>()) &#123;</span><br><span class="line">     <span class="title class_">Log</span>::<span class="title function_ invoke__">info</span>(<span class="string">&quot;sql error:\n&quot;</span> . <span class="variable">$mysqli</span>-&gt;error);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="variable">$mysqli</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line"> <span class="title class_">Log</span>::<span class="title function_ invoke__">info</span>(<span class="string">&#x27;子进程修改图片地址成功&#x27;</span>);</span><br></pre></td></tr></table></figure>


<p> 当然，并不一定都是这个原因</p>
<blockquote>
<p>wait_timeout&#x3D;3600</p>
</blockquote>
<p> 修改wait_timeout和关闭数据库持久连接都是可能的原因</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/pcntl-fork/" rel="tag"># pcntl_fork</a>
              <a href="/tags/%E4%B8%83%E7%89%9B/" rel="tag"># 七牛</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/04/17/swoole-example/" rel="prev" title="swoole-example">
      <i class="fa fa-chevron-left"></i> swoole-example
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/04/27/%E7%94%A8git%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E4%BE%BF%E6%90%BA%E7%89%88sublimetext3/" rel="next" title="用git打造一个便携版SublimeText3">
      用git打造一个便携版SublimeText3 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B"><span class="nav-number">1.</span> <span class="nav-text">实例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#R-DEVICE-ERROR%E9%94%99%E8%AF%AF"><span class="nav-number">2.</span> <span class="nav-text">R_DEVICE_ERROR错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PDO%E9%94%99%E8%AF%AF"><span class="nav-number">3.</span> <span class="nav-text">PDO错误</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">刘星军</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘星军</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
